{
  "S3BucketPolicy": {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Sid": "DatabricksS3Access",
        "Effect": "Allow",
        "Principal": {
          "AWS": "arn:aws:iam::DATABRICKS-DEPLOYMENT-ID:role/unity-catalog-prod-UCMasterRole-RANDOM"
        },
        "Action": [
          "s3:GetObject",
          "s3:GetObjectVersion",
          "s3:PutObject",
          "s3:PutObjectAcl",
          "s3:DeleteObject",
          "s3:ListBucket",
          "s3:GetBucketLocation"
        ],
        "Resource": [
          "arn:aws:s3:::manufacturing-data-pipeline-*",
          "arn:aws:s3:::manufacturing-data-pipeline-*/*"
        ]
      },
      {
        "Sid": "SnowflakeS3Access",
        "Effect": "Allow",
        "Principal": {
          "AWS": "arn:aws:iam::SNOWFLAKE-ACCOUNT-ID:role/snowflake-s3-access-role"
        },
        "Action": [
          "s3:GetObject",
          "s3:GetObjectVersion",
          "s3:ListBucket",
          "s3:GetBucketLocation"
        ],
        "Resource": [
          "arn:aws:s3:::manufacturing-data-pipeline-*",
          "arn:aws:s3:::manufacturing-data-pipeline-*/*"
        ],
        "Condition": {
          "StringEquals": {
            "s3:x-amz-server-side-encryption": "AES256"
          }
        }
      }
    ]
  },
  "DatabricksExecutionRole": {
    "Type": "AWS::IAM::Role",
    "Properties": {
      "RoleName": "DatabricksExecutionRole",
      "AssumeRolePolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "AWS": "arn:aws:iam::414351767826:root"
            },
            "Action": "sts:AssumeRole",
            "Condition": {
              "StringEquals": {
                "sts:ExternalId": "YOUR-DATABRICKS-EXTERNAL-ID"
              }
            }
          }
        ]
      },
      "Policies": [
        {
          "PolicyName": "DatabricksS3Policy",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "s3:ListBucket",
                  "s3:GetBucketLocation"
                ],
                "Resource": [
                  "arn:aws:s3:::manufacturing-data-pipeline-*"
                ]
              },
              {
                "Effect": "Allow",
                "Action": [
                  "s3:GetObject",
                  "s3:GetObjectVersion",
                  "s3:PutObject",
                  "s3:DeleteObject"
                ],
                "Resource": [
                  "arn:aws:s3:::manufacturing-data-pipeline-*/*"
                ]
              }
            ]
          }
        },
        {
          "PolicyName": "DatabricksSecretsManagerPolicy",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "secretsmanager:GetSecretValue",
                  "secretsmanager:DescribeSecret"
                ],
                "Resource": [
                  "arn:aws:secretsmanager:*:*:secret:databricks/*"
                ]
              }
            ]
          }
        }
      ]
    }
  },

  "SnowflakeRole": {
    "Type": "AWS::IAM::Role",
    "Properties": {
      "RoleName": "SnowflakeS3AccessRole",
      "AssumeRolePolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "AWS": "arn:aws:iam::SNOWFLAKE-DEPLOYMENT-REGION-ID:user/SNOWFLAKE-USER"
            },
            "Action": "sts:AssumeRole",
            "Condition": {
              "StringEquals": {
                "sts:ExternalId": "YOUR-SNOWFLAKE-EXTERNAL-ID"
              }
            }
          }
        ]
      },
      "Policies": [
        {
          "PolicyName": "SnowflakeS3AccessPolicy",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "s3:GetObject",
                  "s3:GetObjectVersion",
                  "s3:ListBucket",
                  "s3:GetBucketLocation"
                ],
                "Resource": [
                  "arn:aws:s3:::manufacturing-data-pipeline-*",
                  "arn:aws:s3:::manufacturing-data-pipeline-*/*"
                ]
              }
            ]
          }
        }
      ]
    }
  },

  "DataPipelineExecutionRole": {
    "Type": "AWS::IAM::Role",
    "Properties": {
      "RoleName": "DataPipelineExecutionRole",
      "AssumeRolePolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Service": [
                "lambda.amazonaws.com",
                "glue.amazonaws.com",
                "states.amazonaws.com"
              ]
            },
            "Action": "sts:AssumeRole"
          }
        ]
      },
      "ManagedPolicyArns": [
        "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
        "arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole"
      ],
      "Policies": [
        {
          "PolicyName": "DataPipelinePolicy",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "s3:*"
                ],
                "Resource": [
                  "arn:aws:s3:::manufacturing-data-pipeline-*",
                  "arn:aws:s3:::manufacturing-data-pipeline-*/*"
                ]
              },
              {
                "Effect": "Allow",
                "Action": [
                  "logs:CreateLogGroup",
                  "logs:CreateLogStream",
                  "logs:PutLogEvents"
                ],
                "Resource": "*"
              },
              {
                "Effect": "Allow",
                "Action": [
                  "sns:Publish"
                ],
                "Resource": [
                  "arn:aws:sns:*:*:manufacturing-data-pipeline-*"
                ]
              }
            ]
          }
        }
      ]
    }
  },

  "MonitoringRole": {
    "Type": "AWS::IAM::Role",
    "Properties": {
      "RoleName": "DataPipelineMonitoringRole",
      "AssumeRolePolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Service": "monitoring.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
          }
        ]
      },
      "Policies": [
        {
          "PolicyName": "MonitoringPolicy",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "cloudwatch:PutMetricData",
                  "cloudwatch:GetMetricStatistics",
                  "cloudwatch:ListMetrics",
                  "logs:PutLogEvents",
                  "logs:CreateLogGroup",
                  "logs:CreateLogStream"
                ],
                "Resource": "*"
              }
            ]
          }
        }
      ]
    }
  }
}
